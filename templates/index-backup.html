{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  html, body { overflow-x: hidden; }
  #doc-table-scroll{
    --row-h:56px; --head-h:52px;
    max-height:calc(var(--head-h) + 10 * var(--row-h));
    overflow:auto; overscroll-behavior:contain; scrollbar-gutter:stable both-edges;
  }
  #doc-table-scroll::-webkit-scrollbar{height:12px;width:12px;}
  #doc-table-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:9999px;}
  #doc-table-scroll::-webkit-scrollbar-track{background:#f1f5f9;}
  .title-2lines{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word;line-height:1.25;}
  #doc-table-scroll tbody td{ text-align:center; vertical-align:middle; }
  #doc-table-scroll tbody td:nth-child(2){ text-align:left; }
</style>

<!-- THỐNG KÊ -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
  <!-- Tổng số tài liệu -->
  <div class="rounded-xl border bg-white shadow-sm overflow-hidden">
    <div class="px-5 py-4 bg-blue-50 border-b border-blue-100">
      <div class="flex items-center gap-3">
        <span class="icon-pill bg-blue-500/15 text-blue-600"><i data-lucide="file-text" class="w-5 h-5"></i></span>
        <h3 class="font-semibold text-slate-800">Tổng số tài liệu</h3>
      </div>
    </div>
    <div class="px-5 py-5 text-4xl font-bold text-slate-900">{{ stats.total }}</div>
  </div>

  <!-- Chưa xử lý -->
  <div class="rounded-xl border bg-white shadow-sm overflow-hidden">
    <div class="px-5 py-4 bg-rose-50 border-b border-rose-100">
      <div class="flex items-center gap-3">
        <span class="icon-pill bg-rose-500/15 text-rose-600"><i data-lucide="alert-octagon" class="w-5 h-5"></i></span>
        <h3 class="font-semibold text-slate-800">Chưa xử lý</h3>
      </div>
    </div>
    <div class="px-5 py-5 text-4xl font-bold text-rose-600">{{ stats.unassigned if stats else 0 }}</div>
  </div>

  <!-- Đang xử lý -->
  <div class="rounded-xl border bg-white shadow-sm overflow-hidden">
    <div class="px-5 py-4 bg-amber-50 border-b border-amber-100">
      <div class="flex items-center gap-3">
        <span class="icon-pill bg-amber-500/15 text-amber-600"><i data-lucide="clock-9" class="w-5 h-5"></i></span>
        <h3 class="font-semibold text-slate-800">Đang xử lý</h3>
      </div>
    </div>
    <div class="px-5 py-5 text-4xl font-bold text-amber-600">{{ stats.processing if stats else 0 }}</div>
  </div>

  <!-- Đã xử lý -->
  <div class="rounded-xl border bg-white shadow-sm overflow-hidden">
    <div class="px-5 py-4 bg-emerald-50 border-b border-emerald-100">
      <div class="flex items-center gap-3">
        <span class="icon-pill bg-emerald-500/15 text-emerald-600"><i data-lucide="check-circle-2" class="w-5 h-5"></i></span>
        <h3 class="font-semibold text-slate-800">Đã xử lý</h3>
      </div>
    </div>
    <div class="px-5 py-5 text-4xl font-bold text-emerald-600">{{ stats.completed if stats else 0 }}</div>
  </div>
</div>

<!-- Danh sách + Bộ lọc -->
<div class="rounded-lg border bg-white shadow-sm mt-4">
  <div class="p-6 pb-3 flex items-center justify-between">
    <div>
      <h3 class="tracking-tight text-xl font-semibold">Danh sách Tài liệu</h3>
      <p class="text-sm text-slate-500">Toàn bộ tài liệu có trong hệ thống.</p>
    </div>
    <button data-action="open-add-modal" data-users='{{ users | tojson | forceescape }}'
            class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md shadow-sm text-white bg-slate-800 hover:bg-slate-900">
      <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Thêm mới
    </button>
  </div>

  <!-- Bộ lọc -->
  <div class="px-6 pb-4">
    <form id="filter-form" method="GET" action="{{ url_for('dashboard') }}"
          class="grid gap-3 lg:grid-cols-7 items-end">
      <!-- Xem N mục -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Xem</label>
        <select name="page_size" class="border rounded-md px-3 py-2">
          {% for n in [5,10,20,50,100] %}
            <option value="{{n}}" {% if filters.page_size==n %}selected{% endif %}>{{n}}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Hướng -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Hướng</label>
        <input type="text" name="country" value="{{ filters.country }}" placeholder="VD: Campuchia"
               class="border rounded-md px-3 py-2">
      </div>

      <!-- Trạng thái -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Trạng thái</label>
        <select name="status" class="border rounded-md px-3 py-2">
          <option value=""  {% if not filters.status %}selected{% endif %}>Tất cả</option>
          <option value="Chưa xử lý" {% if filters.status=='Chưa xử lý' %}selected{% endif %}>Chưa xử lý</option>
          <option value="Đang xử lý" {% if filters.status=='Đang xử lý' %}selected{% endif %}>Đang xử lý</option>
          <option value="Đã xử lý"   {% if filters.status=='Đã xử lý'   %}selected{% endif %}>Đã xử lý</option>
        </select>
      </div>

      <!-- Tuần -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Tuần</label>
        <select name="week" class="border rounded-md px-3 py-2">
          <option value="" {% if not filters.week %}selected{% endif %}>Tất cả</option>
          {% for n in range(0,54) %}
            {% set w = "%02d"|format(n) %}
            <option value="{{ w }}" {% if filters.week == w %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Năm -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Năm</label>
        <input type="number" name="year" value="{{ filters.year }}" placeholder="2025"
               class="border rounded-md px-3 py-2">
      </div>

      <!-- Người xử lý -->
      <div class="flex flex-col">
        <label class="text-xs text-slate-500 mb-1">Người xử lý</label>
        <select name="handler_id" class="border rounded-md px-3 py-2">
          <option value="" {% if not filters.handler_id %}selected{% endif %}>Tất cả</option>
          <option value="null" {% if filters.handler_id=='null' %}selected{% endif %}>— Chưa giao —</option>
          {% for u in users %}
            <option value="{{ u.id }}" {% if (filters.handler_id|string) == (u.id|string) %}selected{% endif %}>{{ u.full_name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Tìm theo Tiêu đề + Nút cùng hàng -->
      <div class="lg:col-span-2 flex items-end gap-2">
        <div class="flex-1 flex flex-col">
          <label class="text-xs text-slate-500 mb-1">Tìm theo Tiêu đề</label>
          <input type="text" name="q" value="{{ filters.q }}" placeholder="Nhập tiêu đề để tìm..."
                 class="border rounded-md px-3 py-2">
        </div>
        <div class="pb-[2px] flex gap-2">
          <input type="hidden" name="page" value="{{ page }}">
          <button class="px-4 py-2 rounded-md bg-sky-600 text-white hover:bg-sky-700">Lọc/Tìm</button>
          <a href="{{ url_for('dashboard') }}" class="px-4 py-2 rounded-md border bg-white hover:bg-slate-50">Xóa lọc</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Bảng -->
  <div class="border-t p-0">
    <div id="doc-table-scroll" class="w-full">
      <table class="w-full text-base min-w-[1400px] table-fixed">
        <thead class="bg-slate-100">
          <tr class="border-b">
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap
                       w-[64px] border-r sticky left-0 z-30 bg-slate-100">STT</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap
                       w-[200px] border-r sticky left-[64px] z-20 bg-slate-100">Tiêu đề</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[160px] border-r">Thời gian soạn thảo</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[120px] border-r">Hướng</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[180px] border-r">Người xử lý</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[200px] border-r">Thời gian hoàn thành</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[120px] border-r">Trạng thái</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[130px] border-r">Ghi chú</th>
            <th class="h-12 px-4 text-center font-semibold text-slate-600 whitespace-nowrap w-[140px]">Hành động</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-100">
          {% for doc in documents %}
          <tr class="odd:bg-white even:bg-slate-50/50">
            <td class="p-4 font-medium text-slate-600 border-r sticky left-0 z-20 bg-white">
              {{ (page-1)*filters.page_size + loop.index }}
            </td>
            <td class="p-4 font-medium text-slate-900 border-r sticky left-[64px] z-10 bg-white w-[200px]" title="{{ doc.title }}">
              <div class="title-2lines">{{ doc.title }}</div>
              <p class="font-normal text-sm text-slate-500 truncate" title="{{ doc.authoring_agency }}">{{ doc.authoring_agency }}</p>
            </td>
            <td class="p-4 text-slate-500 text-sm border-r whitespace-nowrap">{{ doc.creation_date|vn_date }}</td>
            <td class="p-4 text-slate-500 text-sm border-r whitespace-nowrap">{{ doc.country }}</td>
            <td class="p-4 text-slate-500 text-sm border-r whitespace-nowrap">{{ doc.handler_name or 'Chưa giao' }}</td>
            <td class="p-4 text-slate-500 text-sm border-r whitespace-nowrap">{{ doc.completion_time|vn_date or '—' }}</td>
            <td class="p-4 border-r whitespace-nowrap">
              {% if doc.status == 'Đã xử lý' %}
                <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-md bg-green-100 text-green-800">{{ doc.status }}</span>
              {% elif doc.status == 'Đang xử lý' %}
                <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-md bg-amber-100 text-amber-800">{{ doc.status }}</span>
              {% else %}
                <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-md bg-red-100 text-red-800">{{ doc.status }}</span>
              {% endif %}
            </td>
            <td class="p-4 text-slate-500 text-sm border-r" title="{{ doc.main_content_summary or '' }}">
              {% if doc.main_content_summary %}
                <div class="truncate">{{ doc.main_content_summary }}</div>
              {% else %} — {% endif %}
            </td>
            <td class="p-4">
              <div class="inline-flex rounded-md shadow-sm">
                <a href="{{ url_for('view_document', doc_id=doc.id) }}" title="Xem"
                   class="px-3 py-2 text-sm font-medium text-white bg-sky-600 rounded-l-lg hover:bg-sky-700">
                  <i data-lucide="eye" class="w-4 h-4"></i>
                </a>
                {% if current_user.user_role == 'admin' %}
                <a href="{{ url_for('view_document', doc_id=doc.id, edit='true') }}" title="Sửa"
                   class="px-3 py-2 text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 border-y border-l border-amber-600">
                  <i data-lucide="pencil" class="w-4 h-4"></i>
                </a>
                <form method="POST" action="{{ url_for('delete_document', doc_id=doc.id) }}"
                      onsubmit="return confirm('Bạn chắc chắn muốn xóa tài liệu này?');">
                  <button class="px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-r-lg hover:bg-red-700 border-y border-l border-red-700" type="submit">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </form>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="9" class="p-8 text-center text-slate-500">Chưa có tài liệu nào.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Phân trang -->
    <div class="p-4 flex flex-col sm:flex-row items-center justify-between gap-3">
      <div class="text-sm text-slate-500">
        Hiển thị trang <span class="font-medium text-slate-700">{{ page }}</span>/<span class="font-medium text-slate-700">{{ total_pages }}</span>,
        tổng <span class="font-medium text-slate-700">{{ total_filtered }}</span> tài liệu.
      </div>
      <div class="flex items-center gap-1">
        {% set f = filters %}
        {% set prev_page = 1 if page <= 1 else page - 1 %}
        {% set next_page = total_pages if page >= total_pages else page + 1 %}
        <a href="{{ url_for('dashboard', q=f.q, country=f.country, status=f.status, week=f.week, year=f.year, handler_id=f.handler_id, page_size=f.page_size, page=prev_page) }}"
           class="px-3 py-1 rounded-md border bg-white hover:bg-slate-50">Trước</a>
        {% for p in range(1, total_pages + 1) %}
          <a href="{{ url_for('dashboard', q=f.q, country=f.country, status=f.status, week=f.week, year=f.year, handler_id=f.handler_id, page_size=f.page_size, page=p) }}"
             class="px-3 py-1 rounded-md border {{ 'bg-slate-900 text-white' if p==page else 'bg-white hover:bg-slate-50' }}">{{ p }}</a>
        {% endfor %}
        <a href="{{ url_for('dashboard', q=f.q, country=f.country, status=f.status, week=f.week, year=f.year, handler_id=f.handler_id, page_size=f.page_size, page=next_page) }}"
           class="px-3 py-1 rounded-md border bg-white hover:bg-slate-50">Sau</a>
      </div>
    </div>
  </div>
</div>

<script>
  lucide.createIcons();
  const form = document.getElementById('filter-form');
  form.querySelector('select[name="page_size"]').addEventListener('change', () => {
    form.querySelector('input[name="page"]').value = 1;
    form.submit();
  });
  form.addEventListener('submit', () => {
    form.querySelector('input[name="page"]').value = 1;
  });
</script>
{% endblock %}

