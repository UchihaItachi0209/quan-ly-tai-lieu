<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Dashboard{% endblock %} - Hệ thống TS-TCM</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{ --sbw:16rem; --sbw-sm:72px; }
    html,body{ height:100%; }
    body{
      font-family:'Inter',sans-serif; font-size:16px;
      /* nền tươi hơn */
      background: linear-gradient(180deg,#f3f7ff 0%, #f8fafc 22%, #ffffff 100%);
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:var(--sbw); background:#1f2937; color:#cbd5e1; transition:width .25s ease;
      box-shadow: 2px 0 10px rgba(2,132,199,.06);
    }
    .sidebar .brand{ height:60px; }
    .sidebar-link{
      display:flex; align-items:center; gap:.75rem;
      padding:.55rem .75rem; border-radius:.5rem; color:#cbd5e1; transition:all .2s;
    }
    .sidebar-link:hover{ color:#fff; background:#334155; }
    .sidebar-link.active{ color:#fff; background:#334155; }
    .label{ white-space:nowrap; }

    /* Collapsed sidebar */
    body.sb-collapsed .sidebar{ width:var(--sbw-sm); }
    body.sb-collapsed .label{ display:none; }
    body.sb-collapsed .brand .title{ display:none; }
    body.sb-collapsed .brand .brand-shield{ display:none !important; } /* ẩn icon khiên */

    /* Main panel padding equals sidebar width */
    .main{ padding-left:var(--sbw); transition:padding-left .25s ease; }
    body.sb-collapsed .main{ padding-left:var(--sbw-sm); }

    /* ===== Header ===== */
    .app-header{
      height:56px; backdrop-filter:saturate(180%) blur(8px);
      background:rgba(255,255,255,.85);
      border-bottom:1px solid #e5e7eb;
    }

    /* ===== Surfaces (làm đẹp card/bảng/badge) ===== */
    .nice-card{
      background:linear-gradient(180deg,#ffffff 0%,#f8fbff 100%);
      border:1px solid #e2e8f0;
      box-shadow:0 8px 24px rgba(2,132,199,.08);
      border-radius:.9rem;
    }
    table thead th{
      background:linear-gradient(180deg,#f1f5f9 0%,#e2e8f0 100%);
      color:#0f172a; font-weight:700;
    }
    table tbody tr:hover{ background:#f8fafc; }
    table td{ border-color:#f1f5f9; }

    .badge{ padding:.28rem .6rem; border-radius:.6rem; font-weight:700; font-size:.75rem; }
    .badge-red{   background:#fee2e2; color:#b91c1c; }
    .badge-amber{ background:#fef3c7; color:#b45309; }
    .badge-green{ background:#dcfce7; color:#166534; }

    /* Label filter to hơn & đậm hơn */
    #filter-form label{ font-size:.95rem; font-weight:600; color:#475569; }
  </style>
</head>
<body>

<!-- ===== Sidebar ===== -->
<aside class="fixed inset-y-0 left-0 z-40 sidebar">
  <div class="flex h-full flex-col">
    <!-- Brand -->
    <div class="brand flex items-center px-4 border-b border-slate-700">
      <button id="sidebar-toggle" class="p-2 rounded hover:bg-slate-700" title="Thu gọn / Mở rộng" type="button">
        <i data-lucide="menu" class="w-5 h-5 text-slate-200"></i>
      </button>
      <div class="flex items-center gap-2 ml-2 text-white font-semibold">
        <i data-lucide="shield" class="brand-shield h-6 w-6 text-sky-400"></i>
        <span class="title">Hệ thống TS-TCM</span>
      </div>
    </div>

    <!-- Profile mini -->
    <div class="px-4 py-3 border-b border-slate-700">
      <div class="flex items-center gap-3">
        <img src="{{ current_user.avatar and url_for('serve_upload', filename=current_user.avatar) or ('https://ui-avatars.com/api/?name=' ~ (current_user.user_name|urlencode)) }}"
             class="w-9 h-9 rounded-full" alt="avatar" />
        <div class="leading-tight">
          <div class="text-sm font-semibold text-white truncate label">{{ current_user.user_name }}</div>
          <div class="text-xs text-slate-400 label">{{ 'Quản trị viên' if current_user.user_role=='admin' else 'Người dùng' }}</div>
        </div>
      </div>
    </div>

    <!-- Nav -->
    <nav class="flex-1 overflow-y-auto px-3 py-3 text-sm">
      <div class="text-xs font-semibold text-slate-400 uppercase px-2 mb-2 label">Thống kê</div>
      <a href="{{ url_for('dashboard') }}"
         class="sidebar-link {{ 'active' if active_page == 'dashboard' }}">
        <i data-lucide="layout-dashboard" class="h-4 w-4"></i><span class="label">Dashboard</span>
      </a>

      <div class="text-xs font-semibold text-slate-400 uppercase px-2 mt-4 mb-2 label">Quản lý</div>
      <a href="{{ url_for('dashboard') }}"
         class="sidebar-link {{ 'active' if active_page == 'documents' }}">
        <i data-lucide="files" class="h-4 w-4"></i><span class="label">Quản lý Tài liệu</span>
      </a>
      <a href="{{ url_for('manage_users') }}"
         class="sidebar-link {{ 'active' if active_page=='users' }}">
        <i data-lucide="users" class="h-4 w-4"></i><span class="label">Quản lý Người dùng</span>
      </a>
    </nav>

    <!-- Logout -->
    <div class="px-3 py-3 border-t border-slate-700">
      <a href="{{ url_for('logout') }}" class="sidebar-link">
        <i data-lucide="log-out" class="h-4 w-4"></i><span class="label">Đăng xuất</span>
      </a>
    </div>
  </div>
</aside>

<!-- ===== Main ===== -->
<div class="main flex min-h-screen flex-col">
  <!-- Header -->
  <header class="app-header flex items-center justify-end px-4 sticky top-0 z-30">
    <div class="relative" id="userMenu">
      <button id="user-btn" class="flex items-center gap-3 p-2 rounded hover:bg-slate-100" type="button">
        <div class="text-right">
          <div class="text-sm font-semibold text-slate-900">{{ current_user.user_name }}</div>
          <div class="text-xs text-slate-500">{{ 'Quản trị viên' if current_user.user_role=='admin' else 'Người dùng' }}</div>
        </div>
        <img src="{{ current_user.avatar and url_for('serve_upload', filename=current_user.avatar) or ('https://ui-avatars.com/api/?name=' ~ (current_user.user_name|urlencode)) }}"
             class="w-9 h-9 rounded-full" alt="avatar" />
        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
      </button>
      <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-44 rounded-md border bg-white shadow-lg">
        <a href="{{ url_for('profile') }}" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 text-sm">
          <i data-lucide="user" class="w-4 h-4"></i> Hồ sơ
        </a>
        <a href="{{ url_for('logout') }}" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 text-sm">
          <i data-lucide="log-out" class="w-4 h-4"></i> Đăng xuất
        </a>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="flex-1 p-4 lg:p-6">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="mb-3 rounded-md px-3 py-2 text-sm
            {{ 'bg-green-100 text-green-800' if category=='success'
             else ('bg-red-100 text-red-800' if category=='error'
             else 'bg-sky-50 text-sky-800') }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>
</div>
{% include 'modals/add_document.html' %}
{% include 'modals/add_user.html' %}
{% include 'modals/view_user.html' %}
{% include 'modals/edit_user.html' %}
<!-- ===== JS ===== -->
<script>
  lucide.createIcons();

  /* Sidebar toggle + remember state */
  const sbKey='sbCollapsed';
  const btnToggle = document.getElementById('sidebar-toggle');
  if (localStorage.getItem(sbKey)==='1') document.body.classList.add('sb-collapsed');
  btnToggle?.addEventListener('click', ()=> {
    document.body.classList.toggle('sb-collapsed');
    localStorage.setItem(sbKey, document.body.classList.contains('sb-collapsed')?'1':'0');
  });

  /* User dropdown */
  const userBtn=document.getElementById('user-btn');
  const userDd=document.getElementById('user-dropdown');
  userBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); userDd?.classList.toggle('hidden'); });
  document.addEventListener('click',(e)=>{ if(!e.target.closest('#userMenu')) userDd?.classList.add('hidden'); });

  /* ===== MODALS ===== */
  const docModal      = document.getElementById('add-document-modal');
  const addUserModal  = document.getElementById('add-user-modal');
  const viewUserModal = document.getElementById('view-user-modal');
  const editUserModal = document.getElementById('edit-user-modal');

  const openModal  = (m)=>{ if(!m) return; m.classList.remove('hidden'); m.classList.add('flex'); };
  const closeModal = (m)=>{ if(!m) return; m.classList.add('hidden');  m.classList.remove('flex'); };

  function populateHandlerDropdown(selectEl, users){
    if(!selectEl) return;
    selectEl.innerHTML = '<option value="null">-- Chưa giao --</option>';
    users.forEach(u=>{
      const opt=document.createElement('option');
      opt.value=u.id; opt.textContent=u.full_name;
      selectEl.appendChild(opt);
    });
  }

  /* BẮT CHẮC cho 2 nút “Thêm mới …” sau khi DOM sẵn sàng */
  document.addEventListener('DOMContentLoaded', ()=>{
    const addDocBtn  = document.querySelector('[data-action="open-add-modal"]');
    const addUserBtn = document.querySelector('[data-action="open-add-user-modal"]');

    addDocBtn?.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      let users=[];
      try{ users = JSON.parse(addDocBtn.dataset.users || '[]'); }catch(_){}
      const form  = docModal?.querySelector('form');
      if(form){
        form.reset();
        const handlerSel = form.querySelector('#form-handler_id, select[name="handler_id"]');
        populateHandlerDropdown(handlerSel, users);
      }
      openModal(docModal);
    });

    addUserBtn?.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      addUserModal?.querySelector('form')?.reset();
      openModal(addUserModal);
    });
  });

  /* Delegation cho view/edit/delete + close */
  document.addEventListener('click',(ev)=>{
    const t = ev.target.closest('[data-action]');
    if(!t) return;
    const action = t.dataset.action;

    /* chặn mặc định để không submit form bất ngờ */
    ev.preventDefault();

    if(action==='open-view-user-modal'){
      const list = JSON.parse(t.dataset.users || '[]');
      const id   = t.dataset.id;
      const u    = list.find(x=>String(x.id)===String(id));
      if(u && viewUserModal){
        viewUserModal.querySelector('#view-full_name').textContent=u.full_name||'';
        viewUserModal.querySelector('#view-position').textContent =u.position||'';
        viewUserModal.querySelector('#view-username').textContent =u.username||'';
        viewUserModal.querySelector('#view-role').textContent     =(u.role==='admin'?'Quản trị viên':'Người dùng');
        openModal(viewUserModal);
      }
      return;
    }

    if(action==='open-edit-user-modal'){
      const list = JSON.parse(t.dataset.users || '[]');
      const id   = t.dataset.id;
      const u    = list.find(x=>String(x.id)===String(id));
      if(u && editUserModal){
        const f = editUserModal.querySelector('form');
        f.action = `/users/${id}/edit`;
        f.querySelector('input[name="full_name"]').value = u.full_name||'';
        f.querySelector('input[name="position"]').value  = u.position||'';
        f.querySelector('input[name="username"]').value  = u.username||'';
        f.querySelector('input[name="username"]').readOnly = true;
        f.querySelector('select[name="role"]').value      = u.role||'user';
        f.querySelector('input[name="password"]').value = '';
        f.querySelector('input[name="confirm_password"]').value = '';
        openModal(editUserModal);
      }
      return;
    }

    if(action==='delete-user'){
      if(confirm('Bạn có chắc chắn muốn xóa người dùng này không?')){
        const form=document.createElement('form');
        form.method='POST'; form.action=`/users/${t.dataset.id}/delete`;
        document.body.appendChild(form); form.submit();
      }
      return;
    }

    if(action==='delete-doc'){
      if(confirm('Bạn có chắc chắn muốn xóa tài liệu này không?')){
        const form=document.createElement('form');
        form.method='POST'; form.action=`/documents/${t.dataset.id}/delete`;
        document.body.appendChild(form); form.submit();
      }
      return;
    }

    if(action==='close-modal'){ closeModal(t.closest('.modal')); }
  });
</script>

</body>
</html>

