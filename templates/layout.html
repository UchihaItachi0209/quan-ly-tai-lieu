<!DOCTYPE html>
<html lang="vi" class="h-full bg-slate-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Dashboard{% endblock %} - Hệ thống TCM chuyên sâu</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>

  <style>
    :root{ --sb-bg:#3a4150; --sb-text:#e5e7eb; --sb-text-dim:#cbd5e1; }
    body{font-family:'Inter',sans-serif}
    #app-grid{display:grid;min-height:100vh;grid-template-columns:280px 1fr;}
    @media (max-width:1023px){ #app-grid{grid-template-columns:1fr;} }
    .sidebar{background:var(--sb-bg);color:var(--sb-text)}
    .sidebar[data-collapsed="true"] .nav-label,
    .sidebar[data-collapsed="true"] .section-title,
    .sidebar[data-collapsed="true"] .user-block .meta{display:none}
    .sidebar[data-collapsed="true"]{width:76px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;color:var(--sb-text-dim)}
    .nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
    .nav-item.active{background:rgba(255,255,255,.12);color:#fff}
    .icon-pill{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:999px}
    header{position:sticky;top:0;z-index:30}
    @media (max-width:1023px){
      #sidebar{position:fixed;inset:0 40% 0 0;transform:translateX(-100%);transition:transform .25s}
      #sidebar[data-open="true"]{transform:none}
      #sidebar .panel{width:280px;height:100%}
      #sidebar .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    }
  </style>
</head>
<body class="h-full">
<div id="app-grid">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" data-collapsed="false">
    <div class="overlay lg:hidden hidden" id="sidebar-overlay"></div>
    <div class="panel h-full border-r border-gray-600">
      <div class="h-[60px] flex items-center justify-between px-4 border-b border-gray-600">
        <a href="{{ url_for('dashboard') }}" class="flex items-center gap-3 text-white">
          <span class="icon-pill bg-emerald-500/20 text-emerald-300"><i data-lucide="shield" class="w-5 h-5"></i></span>
          <span class="nav-label text-[15px] font-semibold">Hệ thống TCM chuyên sâu</span>
        </a>
        <button id="collapse-btn" class="hidden lg:inline-flex p-2 rounded hover:bg-gray-600" title="Thu gọn/Mở rộng">
          <i data-lucide="panel-left-close" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="px-3 py-3">
        <div class="user-block flex items-center gap-3 px-2 py-2 rounded-lg bg-gray-600/50">
          <img src="https://ui-avatars.com/api/?name={{ current_user.user_name|urlencode }}&background=0ea5e9&color=fff&rounded=true&size=64" class="h-9 w-9 rounded-full" alt="avatar">
          <div class="meta">
            <div class="font-semibold text-white leading-5 text-sm">{{ current_user.user_name }}</div>
            <div class="text-[11px] text-gray-300">{{ 'Quản trị viên' if current_user.user_role == 'admin' else 'Người dùng' }}</div>
          </div>
        </div>
      </div>

      <nav class="px-3 pb-4 text-sm font-medium space-y-2">
        <div class="section-title text-xs uppercase px-2 mt-2 mb-1">THỐNG KÊ</div>
        <a href="{{ url_for('dashboard') }}" class="nav-item {{ 'active' if active_page == 'dashboard' }}">
          <span class="icon-pill bg-sky-500/15 text-sky-300"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></span>
          <span class="nav-label">Dashboard</span>
        </a>

        <div class="section-title text-xs uppercase px-2 mt-4 mb-1">QUẢN LÝ</div>
        <a href="{{ url_for('dashboard') }}" class="nav-item {{ 'active' if active_page == 'documents' }}">
          <span class="icon-pill bg-indigo-500/15 text-indigo-300"><i data-lucide="files" class="w-5 h-5"></i></span>
          <span class="nav-label">Quản lý Tài liệu</span>
        </a>
        <a href="{{ url_for('manage_users') }}" class="nav-item {{ 'active' if active_page == 'users' }}">
          <span class="icon-pill bg-teal-500/15 text-teal-300"><i data-lucide="users" class="w-5 h-5"></i></span>
          <span class="nav-label">Quản lý Người dùng</span>
        </a>

        <a href="{{ url_for('logout') }}" class="nav-item">
          <span class="icon-pill bg-rose-500/15 text-rose-300"><i data-lucide="log-out" class="w-5 h-5"></i></span>
          <span class="nav-label">Đăng xuất</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <div class="flex flex-col">
    <header class="flex h-14 items-center gap-4 border-b bg-white px-4 lg:h-[60px] lg:px-6">
      <button id="menu-button" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6"></i></button>
      <div class="w-full flex-1"></div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <p class="font-semibold text-sm text-slate-900">{{ current_user.user_name }}</p>
          <p class="text-xs text-slate-500">{{ 'Quản trị viên' if current_user.user_role == 'admin' else 'Người dùng' }}</p>
        </div>
        <img src="https://ui-avatars.com/api/?name={{ current_user.user_name|urlencode }}&background=0284c7&color=fff&rounded=true&size=40" class="rounded-full" alt="avatar">
        <a href="{{ url_for('logout') }}" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-900"><i data-lucide="log-out" class="w-5 h-5"></i></a>
      </div>
    </header>

    <main class="flex flex-1 flex-col gap-4 p-4 lg:gap-6 lg:p-6 bg-slate-100">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="w-full text-base p-3 rounded-md {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-700' }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
  </div>
</div>

<!-- Modals -->
{% include 'modals/add_document.html' %}
{% include 'modals/add_user.html' %}
{% include 'modals/view_user.html' %}
{% include 'modals/edit_user.html' %}

<script>
  lucide.createIcons();

  // Sidebar open/collapse
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const menuBtn = document.getElementById('menu-button');
  const collapseBtn = document.getElementById('collapse-btn');
  menuBtn?.addEventListener('click', () => {
    const isOpen = sidebar.getAttribute('data-open') === 'true';
    sidebar.setAttribute('data-open', isOpen ? 'false' : 'true');
    overlay.classList.toggle('hidden', isOpen);
  });
  overlay?.addEventListener('click', () => {
    sidebar.setAttribute('data-open', 'false'); overlay.classList.add('hidden');
  });
  collapseBtn?.addEventListener('click', () => {
    const isCollapsed = sidebar.getAttribute('data-collapsed') === 'true';
    sidebar.setAttribute('data-collapsed', isCollapsed ? 'false' : 'true');
  });

  // ===== Modal logic =====
  const docModal      = document.getElementById('add-document-modal');
  const addUserModal  = document.getElementById('add-user-modal');
  const viewUserModal = document.getElementById('view-user-modal');
  const editUserModal = document.getElementById('edit-user-modal');

  function openModal(m){ m?.classList.remove('hidden'); m?.classList.add('flex'); }
  function closeModal(m){ m?.classList.add('hidden'); m?.classList.remove('flex'); }

  function populateHandlerDropdown(selectEl, users){
    if(!selectEl) return;
    selectEl.innerHTML = '<option value="null">-- Chưa giao --</option>';
    (users||[]).forEach(u=>{
      const opt=document.createElement('option');
      opt.value=u.id; opt.textContent=u.full_name; selectEl.appendChild(opt);
    });
  }

  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('[data-action]');
    if(!btn) return;
    const act = btn.dataset.action;

    if(act==='open-add-modal'){
      const users = JSON.parse(btn.dataset.users||'[]');
      const form  = docModal?.querySelector('form');
      form?.reset();
      populateHandlerDropdown(document.getElementById('form-handler_id'), users);
      openModal(docModal);
      lucide.createIcons();
    }
    if(act==='open-add-user-modal'){ openModal(addUserModal); lucide.createIcons(); }
    if(act==='open-view-user-modal'){
      const data=JSON.parse(btn.dataset.user||'{}');
      if(viewUserModal){
        viewUserModal.querySelector('#view-full_name').textContent = data.full_name||'';
        viewUserModal.querySelector('#view-position').textContent  = data.position||'';
        viewUserModal.querySelector('#view-username').textContent  = data.username||'';
        viewUserModal.querySelector('#view-role').textContent      = data.role==='admin'?'Quản trị viên':'Người dùng';
      }
      openModal(viewUserModal); lucide.createIcons();
    }
    if(act==='open-edit-user-modal'){
      const data=JSON.parse(btn.dataset.user||'{}');
      const form = editUserModal?.querySelector('form'); if(!form) return;
      form.action = `/users/${data.id}/edit`;
      form.querySelector('input[name="full_name"]').value = data.full_name||'';
      form.querySelector('input[name="position"]').value  = data.position||'';
      form.querySelector('input[name="username"]').value  = data.username||'';
      form.querySelector('input[name="username"]').readOnly = true;
      form.querySelector('select[name="role"]').value     = data.role||'user';
      form.querySelector('input[name="password"]').value  = '';
      form.querySelector('input[name="confirm_password"]').value = '';
      openModal(editUserModal); lucide.createIcons();
    }
    if(act==='close-modal'){ closeModal(btn.closest('.modal')); }
  });

  // Validate password
  const addUserForm = addUserModal?.querySelector('form');
  if(addUserForm){
    const p=addUserForm.querySelector('input[name="password"]');
    const c=addUserForm.querySelector('input[name="confirm_password"]');
    const msg=addUserForm.querySelector('#add-password-mismatch-message');
    const check=()=>{ if(c.value && p.value!==c.value){ msg.classList.remove('hidden'); return false;} msg.classList.add('hidden'); return true; };
    p.addEventListener('input',check); c.addEventListener('input',check);
    addUserForm.addEventListener('submit',e=>{ if(!check()) e.preventDefault(); });
  }
  const editUserForm = editUserModal?.querySelector('form');
  if(editUserForm){
    const p=editUserForm.querySelector('input[name="password"]');
    const c=editUserForm.querySelector('input[name="confirm_password"]');
    const msg=editUserForm.querySelector('#edit-password-mismatch-message');
    const check=()=>{ if((p.value||c.value) && p.value!==c.value){ msg.classList.remove('hidden'); return false;} msg.classList.add('hidden'); return true; };
    p.addEventListener('input',check); c.addEventListener('input',check);
    editUserForm.addEventListener('submit',e=>{ if(!check()) e.preventDefault(); });
  }
</script>
</body>
</html>

